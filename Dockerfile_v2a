# SPDX-License-Identifier: Apache-2.0
# File: Dockerfile v.2 alfa --refactoring--
# Description:
#     Dockerfile for the AstraDesk API service.
#     Builds a Python 3.14-based image for running the API with Uvicorn.
#     Supports mTLS/TLS certificates (via /secrets) and Istio integration.
#     Compatible with deploy/istio/, packages/domain-support/, and Admin API (/secrets).
# Author: Siergej Sobolewski
# Since: 2025-10-22

# --- Build Stage ---
FROM python:3.14-slim AS builder

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    UV_EXTRA_INDEX_URL="https://download.pytorch.org/whl/cu121" \
    UV_INDEX_STRATEGY="unsafe-best-match"

WORKDIR /app

# Install uv and dependencies
RUN pip install --no-cache-dir uv

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq-dev gcc && rm -rf /var/lib/apt/lists/*

# Copy project files
COPY pyproject.toml uv.lock ./
COPY packages/ ./packages/

# Install dependencies
RUN uv sync --all-extras --frozen

# --- Final Stage ---
FROM python:3.14-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    API_PORT=8080

WORKDIR /app

# Copy installed dependencies from builder
COPY --from=builder /app/.venv /app/.venv

# Copy source code
COPY src ./src

# Create non-root user
RUN useradd -m astradesk
USER astradesk

# Expose port
EXPOSE 8080

# Healthcheck
HEALTHCHECK --interval=10s --timeout=5s --retries=5 \
    CMD curl -f http://localhost:8080/api/admin/v1/health || exit 1

# Run Uvicorn
CMD ["/app/.venv/bin/uv", "run", "uvicorn", "src.gateway.main:app", "--host", "0.0.0.0", "--port", "8080"]
